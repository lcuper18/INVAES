<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .param-item { display: flex; justify-content: space-between; align-items: center; background-color: #e5e7eb; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; color: #1f2937; }
        .param-item button { margin-left: 0.75rem; color: #ef4444; font-weight: bold; }
        .param-item button:hover { color: #b91c1c; }
        .tab-btn-cliente { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; font-weight: 500; cursor: pointer; }
        .tab-btn-cliente.active { border-color: #4f46e5; color: #4f46e5; }
        .tab-content-cliente { display: none; }
        .tab-content-cliente.active { display: block; }
        select:disabled { background-color: #f3f4f6; }
        .sede-card { border: 1px solid #d1d5db; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .asset-table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
        .asset-table th, .asset-table td { text-align: left; padding: 0.5rem; border-bottom: 1px solid #e5e7eb; }
        .asset-table th { background-color: #f9fafb; }

        /* Estilos para la lista de clientes */
        .client-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #f9fafb;
            cursor: pointer;
        }
        .client-card-header:hover {
            background-color: #f3f4f6;
        }
        .client-card-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.5rem;
        }
        .client-card-body.open {
            padding: 1.5rem;
            max-height: 1000px; /* Ajusta esto si el contenido es muy grande */
        }
        .client-card-header .arrow {
            transition: transform 0.3s ease-in-out;
        }
        .client-card-header.open .arrow {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-6 lg:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-10">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-gray-800">Gestión de Clientes</h1>

        <!-- Pestañas de Navegación -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <button class="tab-btn-cliente active" data-tab="agregar">Agregar/Editar Cliente</button>
                <button class="tab-btn-cliente" data-tab="lista">Lista de Clientes</button>
            </nav>
        </div>

        <!-- Contenido de Pestaña: Agregar/Editar Cliente -->
        <div id="tab-agregar" class="tab-content-cliente active">
            <form id="cliente-form" class="space-y-8">
                
                <!-- Datos Generales del Cliente -->
                <fieldset class="border rounded-lg p-6">
                    <legend class="text-xl font-semibold text-gray-900 px-2">Datos Generales del Cliente</legend>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">Tipo de Cliente</label>
                        <div class="mt-2 flex items-center gap-x-6">
                            <label><input type="radio" name="tipo_cliente" value="fisica" class="mr-2" checked> Persona Física</label>
                            <label><input type="radio" name="tipo_cliente" value="juridica" class="mr-2"> Persona Jurídica</label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label id="label-nombre" for="nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                            <input type="text" id="nombre" name="nombre" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>
                        <div>
                            <label id="label-id" for="identificacion" class="block text-sm font-medium text-gray-700">Identificación (Cédula)</label>
                            <input type="text" id="identificacion" name="identificacion" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" required>
                        </div>
                    </div>
                </fieldset>

                <!-- Sedes del Cliente -->
                <fieldset class="border rounded-lg p-6">
                    <legend class="text-xl font-semibold text-gray-900 px-2">Sedes y Activos del Cliente</legend>
                    <div id="sedes-container" class="space-y-6">
                        <!-- Las sedes se agregarán aquí dinámicamente -->
                    </div>
                    <div class="mt-6 text-right">
                        <button type="button" id="btn-agregar-sede" class="px-5 py-2 text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700">Agregar Sede</button>
                    </div>
                </fieldset>

                <div class="pt-6 text-right space-x-4">
                    <button type="button" class="px-6 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-6 py-2 text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700">Guardar Cliente</button>
                </div>
            </form>
        </div>

        <!-- Contenido de Pestaña: Lista de Clientes -->
        <div id="tab-lista" class="tab-content-cliente">
            <div class="mb-4">
                <input type="text" id="search-input" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Buscar cliente...">
            </div>
            <div id="client-list-container" class="space-y-4">
                <!-- Los clientes se cargarán aquí -->
            </div>
        </div>
    </div>

    <!-- Template para la tarjeta de Sede -->
    <template id="sede-template">
        <div class="sede-card bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Detalles de la Sede</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="sede-nombre" class="block text-sm font-medium text-gray-700">Nombre de la Sede</label>
                    <input type="text" name="sede_nombre" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Ej: Oficina Central, Sucursal Este">
                </div>
                <div>
                    <label for="sede-contrato" class="block text-sm font-medium text-gray-700">Contrato</label>
                    <input type="text" name="sede_contrato" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="ID o descripción del contrato">
                </div>
                <div>
                    <label for="sede-telefono" class="block text-sm font-medium text-gray-700">Teléfono de la Sede</label>
                    <input type="tel" name="sede_telefono" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div>
                    <label for="sede-email" class="block text-sm font-medium text-gray-700">Email de la Sede</label>
                    <input type="email" name="sede_email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm">
                </div>
                 <div class="md:col-span-2">
                    <label for="sede-contacto" class="block text-sm font-medium text-gray-700">Persona de Contacto</label>
                    <input type="text" name="sede_contacto" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Nombre del contacto principal en la sede">
                </div>
                <!-- Dirección de la Sede -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Dirección de la Sede</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <select name="sede_provincia" class="sede-provincia mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></select>
                        </div>
                        <div>
                            <select name="sede_canton" class="sede-canton mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm" disabled></select>
                        </div>
                        <div>
                            <select name="sede_distrito" class="sede-distrito mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm" disabled></select>
                        </div>
                        <div class="sm:col-span-3">
                            <textarea name="sede_direccion_exacta" rows="2" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Señas y otros detalles"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventario de Activos -->
            <div class="mt-6">
                <h4 class="text-md font-semibold text-gray-800">Inventario de Activos en esta Sede</h4>
                <div class="overflow-x-auto">
                    <table class="asset-table">
                        <thead>
                            <tr>
                                <th>Activo/Descripción</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Serie</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody class="asset-list">
                            <!-- Filas de activos se agregarán aquí -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex gap-4 items-end p-2 bg-gray-100 rounded-lg">
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600">Descripción</label>
                        <input type="text" class="new-asset-descripcion w-full mt-1 px-2 py-1 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600">Marca</label>
                        <input type="text" class="new-asset-marca w-full mt-1 px-2 py-1 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600">Modelo</label>
                        <input type="text" class="new-asset-modelo w-full mt-1 px-2 py-1 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600">Serie</label>
                        <input type="text" class="new-asset-serie w-full mt-1 px-2 py-1 border border-gray-300 rounded-md">
                    </div>
                    <button type="button" class="btn-agregar-activo h-9 px-4 text-sm font-medium rounded-lg text-white bg-blue-500 hover:bg-blue-600">Añadir</button>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button type="button" class="btn-eliminar-sede text-red-600 hover:text-red-800 text-sm font-medium">Eliminar Sede</button>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let geoData = {};

            // --- LÓGICA PARA LA LISTA DE CLIENTES ---
            function loadClients() {
                fetch('./db/clientes.json')
                    .then(response => response.json())
                    .then(clients => {
                        const container = document.getElementById('client-list-container');
                        container.innerHTML = ''; // Limpiar antes de agregar
                        clients.forEach(client => {
                            const clientCard = document.createElement('div');
                            clientCard.className = 'client-card';

                            let sedesHtml = '';
                            client.sedes.forEach(sede => {
                                let contactosHtml = '';
                                sede.contactos.forEach(contacto => {
                                    contactosHtml += `
                                        <div class="mt-2 p-2 bg-gray-100 rounded-md">
                                            <p><strong>Contacto:</strong> ${contacto.nombre_contacto}</p>
                                            <p><strong>Teléfonos:</strong> ${contacto.telefonos.join(', ')}</p>
                                            <p><strong>Emails:</strong> ${contacto.emails.join(', ')}</p>
                                        </div>
                                    `;
                                });

                                sedesHtml += `
                                    <div class="mt-4 p-3 bg-white rounded-lg border">
                                        <h4 class="font-semibold">${sede.nombre_sede}</h4>
                                        <p><strong>Dirección:</strong> ${sede.direccion}</p>
                                        ${contactosHtml}
                                    </div>
                                `;
                            });

                            clientCard.innerHTML = `
                                <div class="client-card-header">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800">${client.nombre_cliente}</h3>
                                        <p class="text-sm text-gray-500">ID: ${client.id_cliente}</p>
                                    </div>
                                    <div class="arrow text-gray-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                                    </div>
                                </div>
                                <div class="client-card-body">
                                    <h4 class="text-md font-semibold mb-2">Sedes:</h4>
                                    ${sedesHtml}
                                </div>
                            `;

                            container.appendChild(clientCard);

                            const header = clientCard.querySelector('.client-card-header');
                            const body = clientCard.querySelector('.client-card-body');
                            header.addEventListener('click', () => {
                                body.classList.toggle('open');
                                header.classList.toggle('open');
                            });
                        });
                    })
                    .catch(error => console.error('Error al cargar los clientes:', error));

                const searchInput = document.getElementById('search-input');
                searchInput.addEventListener('keyup', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const clientCards = document.querySelectorAll('.client-card');
                    clientCards.forEach(card => {
                        const cardText = card.textContent.toLowerCase();
                        if (cardText.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            }

            // Función para inicializar toda la lógica de la aplicación
            function initializeApp() {
                // --- LÓGICA DE PESTAÑAS ---
                const tabButtons = document.querySelectorAll('.tab-btn-cliente');
                const tabContents = document.querySelectorAll('.tab-content-cliente');
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        tabContents.forEach(content => content.classList.remove('active'));
                        const activeTab = document.getElementById(`tab-${button.dataset.tab}`);
                        activeTab.classList.add('active');

                        if (button.dataset.tab === 'lista') {
                            loadClients();
                        }
                    });
                });

                // --- LÓGICA TIPO DE CLIENTE ---
                const tipoClienteRadios = document.querySelectorAll('input[name="tipo_cliente"]');
                const labelNombre = document.getElementById('label-nombre');
                const labelId = document.getElementById('label-id');
                tipoClienteRadios.forEach(radio => {
                    radio.addEventListener('change', e => {
                        if (e.target.value === 'juridica') {
                            labelNombre.textContent = 'Razón Social';
                            labelId.textContent = 'Cédula Jurídica';
                        } else {
                            labelNombre.textContent = 'Nombre Completo';
                            labelId.textContent = 'Identificación (Cédula)';
                        }
                    });
                });

                // --- LÓGICA PARA DIRECCIONES Y SEDES ---
                const populateSelect = (selectElement, items, placeholder) => {
                    selectElement.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                    items.forEach(item => selectElement.add(new Option(item, item)));
                };

                function setupGeoSelectors(provinciaSelect, cantonSelect, distritoSelect) {
                    populateSelect(provinciaSelect, Object.keys(geoData), "Seleccione Provincia");

                    provinciaSelect.addEventListener('change', () => {
                        const selectedProvincia = provinciaSelect.value;
                        distritoSelect.innerHTML = '<option value="" disabled selected>Seleccione Distrito</option>';
                        distritoSelect.disabled = true;
                        if (selectedProvincia && geoData[selectedProvincia]) {
                            const cantones = Object.keys(geoData[selectedProvincia].cantones);
                            populateSelect(cantonSelect, cantones, "Seleccione Cantón");
                            cantonSelect.disabled = false;
                        } else {
                            cantonSelect.innerHTML = '<option value="" disabled selected>Seleccione Cantón</option>';
                            cantonSelect.disabled = true;
                        }
                    });

                    cantonSelect.addEventListener('change', () => {
                        const selectedProvincia = provinciaSelect.value;
                        const selectedCanton = cantonSelect.value;
                        if (selectedCanton && geoData[selectedProvincia] && geoData[selectedProvincia].cantones[selectedCanton]) {
                            const distritos = geoData[selectedProvincia].cantones[selectedCanton].distritos;
                            if (distritos && distritos.length > 0) {
                                populateSelect(distritoSelect, distritos, "Seleccione Distrito");
                                distritoSelect.disabled = false;
                            } else {
                                populateSelect(distritoSelect, [], 'No hay distritos');
                                distritoSelect.disabled = true;
                            }
                        } else {
                            distritoSelect.innerHTML = '<option value="" disabled selected>Seleccione Distrito</option>';
                            distritoSelect.disabled = true;
                        }
                    });
                }

                const sedesContainer = document.getElementById('sedes-container');
                const sedeTemplate = document.getElementById('sede-template');
                document.getElementById('btn-agregar-sede').addEventListener('click', () => {
                    const sedeClone = sedeTemplate.content.cloneNode(true);
                    const sedeCard = sedeClone.querySelector('.sede-card');
                    
                    const provinciaSelect = sedeCard.querySelector('.sede-provincia');
                    const cantonSelect = sedeCard.querySelector('.sede-canton');
                    const distritoSelect = sedeCard.querySelector('.sede-distrito');
                    setupGeoSelectors(provinciaSelect, cantonSelect, distritoSelect);

                    sedesContainer.appendChild(sedeClone);
                    
                    const newSedeCard = sedesContainer.lastElementChild;
                    const btnAgregarActivo = newSedeCard.querySelector('.btn-agregar-activo');
                    const assetList = newSedeCard.querySelector('.asset-list');
                    
                    btnAgregarActivo.addEventListener('click', () => {
                        const desc = newSedeCard.querySelector('.new-asset-descripcion').value;
                        const marca = newSedeCard.querySelector('.new-asset-marca').value;
                        const modelo = newSedeCard.querySelector('.new-asset-modelo').value;
                        const serie = newSedeCard.querySelector('.new-asset-serie').value;

                        if(desc && marca && modelo && serie) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${desc}</td>
                                <td>${marca}</td>
                                <td>${modelo}</td>
                                <td>${serie}</td>
                                <td><button type="button" class="text-red-500 hover:text-red-700 text-xs font-bold">X</button></td>
                            `;
                            assetList.appendChild(row);
                            
                            newSedeCard.querySelector('.new-asset-descripcion').value = '';
                            newSedeCard.querySelector('.new-asset-marca').value = '';
                            newSedeCard.querySelector('.new-asset-modelo').value = '';
                            newSedeCard.querySelector('.new-asset-serie').value = '';

                            row.querySelector('button').addEventListener('click', () => row.remove());
                        } else {
                            alert('Por favor complete todos los campos del activo.');
                        }
                    });

                    newSedeCard.querySelector('.btn-eliminar-sede').addEventListener('click', (e) => {
                        e.target.closest('.sede-card').remove();
                    });
                });

                // --- LÓGICA DE GUARDADO ---
                document.getElementById('cliente-form').addEventListener('submit', e => {
                    e.preventDefault();
                    alert('Lógica de guardado principal (aún no implementada). Revisa la consola para ver la estructura de datos.');
                    
                    const formData = new FormData(e.target);
                    const clienteData = {
                        tipo_cliente: formData.get('tipo_cliente'),
                        nombre: formData.get('nombre'),
                        identificacion: formData.get('identificacion'),
                        sedes: []
                    };

                    document.querySelectorAll('.sede-card').forEach(sedeCard => {
                        const sede = {
                            nombre: sedeCard.querySelector('[name="sede_nombre"]').value,
                            contrato: sedeCard.querySelector('[name="sede_contrato"]').value,
                            telefono: sedeCard.querySelector('[name="sede_telefono"]').value,
                            email: sedeCard.querySelector('[name="sede_email"]').value,
                            contacto: sedeCard.querySelector('[name="sede_contacto"]').value,
                            provincia: sedeCard.querySelector('[name="sede_provincia"]').value,
                            canton: sedeCard.querySelector('[name="sede_canton"]').value,
                            distrito: sedeCard.querySelector('[name="sede_distrito"]').value,
                            direccion_exacta: sedeCard.querySelector('[name="sede_direccion_exacta"]').value,
                            activos: []
                        };

                        sedeCard.querySelectorAll('.asset-list tr').forEach(row => {
                            const cells = row.querySelectorAll('td');
                            sede.activos.push({
                                descripcion: cells[0].textContent,
                                marca: cells[1].textContent,
                                modelo: cells[2].textContent,
                                serie: cells[3].textContent
                            });
                        });
                        clienteData.sedes.push(sede);
                    });

                    console.log(JSON.stringify(clienteData, null, 2));
                });
            }

            // Cargar datos geográficos y luego inicializar la app
            fetch('./db/provincias_cantones_distritos.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    geoData = data;
                    initializeApp(); // Llama a la función principal después de cargar los datos
                })
                .catch(error => console.error('Error al cargar los datos geográficos:', error));
        });
    </script>

</body>
</html>